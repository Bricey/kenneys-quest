var RPG=RPG||{};RPG.NPC=function(t,i,a,s){Phaser.Sprite.call(this,t.game,i,a,s.name),this.state=t,this.game=t.game,this.data=s,this.anchor.setTo(.5),this.collideWorldBounds=!0,this.direction=1,this.speed=40,this.isMoving=!1,this.targetX=0,this.targetY=0,this.movePause=!1,this.dialogueEngaged=!1;var e=8;this.data.customAnimation?(this.animations.add("walkSide",[2],null,null),this.animations.add("walkFwd",[0],null,null),this.animations.add("walkBwd",[1],null,null)):"npc_cow"===this.data.name?(this.animations.add("walkSide",[8,9,10,11],e,!0),this.animations.add("walkFwd",[0,1,2,3],e,!0),this.animations.add("walkBwd",[4,5,6,7],e,!0)):(this.animations.add("walkSide",[7,8,7,9],e,!0),this.animations.add("walkFwd",[0,1,0,2],e,!0),this.animations.add("walkBwd",[3,4,3,5],e,!0),this.animations.add("success",[6],e,!0),this.animations.add("celebrate",[6,6,0],2,!0)),this.data.customAnimation&&void 0!=this.data.animation&&(this.animations.add("custom",this.data.animation[0],this.data.animation[1],!0),this.animations.play("custom")),this.game.physics.arcade.enable(this),this.body.collideWorldBounds=!0,this.body.immovable=!0,this.inputEnabled=!0,this.input.useHandCursor=!0,this.body.onCollide=new Phaser.Signal,this.events.onInputOver.add(this.onHover,this),this.events.onInputOut.add(this.onOut,this),this.events.onInputDown.add(this.onSelected,this)},RPG.NPC.prototype=Object.create(Phaser.Sprite.prototype),RPG.NPC.prototype.constructor=RPG.NPC,RPG.NPC.prototype.update=function(){if(this.inCamera&&!this.data.static)if(null!=this.nameLabel&&(this.nameLabel.x=this.x,this.nameLabel.y=this.y-70),this.isMoving||this.movePause||this.dialogueEngaged){if(this.isMoving&&!this.dialogueEngaged){var t=this.world.x-this.targetX,i=this.world.y-this.targetY;if(t>-5&&t<5&&i>-5&&i<5){this.body.velocity.setTo(0,0),this.animations.play("walkFwd").stop(!0),this.isMoving=!1,this.scale.setTo(1);var a=this;setTimeout(function(){a.movePause=!1},1e3*Rnd(2,4))}}}else this.isMoving=!0,this.movePause=!0,this.targetX=this.world.x+Rnd.sign()*Rnd(0,6)*60,this.targetY=this.world.y+Rnd.sign()*Rnd(0,3)*60,this.faceDirection(this.targetX,this.targetY,null),RPG.game.physics.arcade.moveToXY(this,this.targetX,this.targetY,this.speed)},RPG.NPC.prototype.stopMoving=function(){this.frame=0;var t=this;setTimeout(function(){t.isMoving=!1,t.movePause=!1},1e3)},RPG.NPC.prototype.onSelected=function(){RPG.GameState.dialogueUp||(Player.engageDialogue=!0,RPG.GameState.faceDirection(Player,this.x,this.y),RPG.GameState.physics.arcade.moveToObject(Player,this,120),this.dialogueEngaged?Player.animations.stop(!1):this.body.onCollide.add(this.talk,this))},RPG.NPC.prototype.onHover=function(){if(RPG.GameState.nameLabel.setText(this.data.character),RPG.GameState.nameLabel.reset(this.world.x,this.world.y-70),"ontouchstart"in document.documentElement){setTimeout(function(){this.onOut()},2e3)}},RPG.NPC.prototype.onOut=function(){RPG.GameState.nameLabel.kill()},RPG.NPC.prototype.talk=function(){this.body.onCollide.removeAll(),this.body.velocity.setTo(0),this.data.static||RPG.GameState.faceDirection(this,Player.world.x,Player.world.y),this.animations.stop(!0),this.dialogueEngaged=!0,this.movePause=!0,Player.body.velocity.setTo(0),RPG.GameState.faceDirection(Player,this.world.x,this.world.y),Player.animations.stop(!0),RPG.GameState.initDialogue(this.data,this.data.portrait,!0,this)},RPG.NPC.prototype.faceDirection=function(t,i,a){var s=t>this.x,e=i>this.y;this.scale.setTo(1),s&&e?this.animations.play("walkFwd"):!s&&e?(this.animations.play("walkSide"),this.scale.setTo(-1,1)):s&&!e?this.animations.play("walkSide"):s||e||(this.animations.play("walkSide"),this.scale.setTo(-1,1)),a&&this.animations.stop(!0)};