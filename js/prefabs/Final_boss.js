var RPG=RPG||{};RPG.bossType={};var shadow;RPG.Final_boss=function(t,e,i,s){Phaser.Sprite.call(this,t.game,e,i,s.name),this.state=t,this.game=t.game,this.data=s,this.anchor.setTo(.5,.85),this.collideWorldBounds=!0;var a=this;this.states=[function(){a.move()},function(){a.recharge()},function(){a.sweep()},function(){a.engageShooting()},function(){a.missile()},function(){a.jump()}],this.state="hover",this.targetX=0,this.targetY=0,this.isHit=!1,this.isMoving=!1,this.isDead=!1,this.isAttacking=!1,this.isJumping=!1,this.startPos=[e,740],this.xBounds=[590,1190],this.yBounds=[760,1060],this.targetDistance=90,this.health=60,this.moveChance=[0,0,1,1,1,3,3,2,2,1,1,3,3,3,3,1,4,4,5,5],this.shootRate=.05,this.missileRate=1.2,this.data.attack=1,this.nextMoveFired=!1,this.shootType=0,this.shootInteger=0,this.shootDireciton=1,this.jumpNums=0,this.invulnerable=!0,this.returnX=0,this.returnY=740,this.shootMax=24,this.rechargeAudio=RPG.game.add.audio("recharge",.8,!0),this.powerDown=RPG.game.add.audio("power_down"),this.missileGroup=RPG.GameState.add.group(),this.health=50,this.shootingTimer=this.game.time.create(!1),this.animations.add("hover",[0,1,2,1,0,3,4,3],8,!0),this.animations.add("attack",[5,6],12,!0),this.animations.add("fall",[9,10,11,12],4,!1),this.animations.add("getUp",[12,11,10,9],4,!1),this.animations.add("recharge",[12,13,14],2,!0),this.animations.add("jump",[7],40,!1),this.animations.add("missile",[8,9,15,8],20,!1),this.hitSound="boss_hit",this.game.physics.arcade.enable(this),this.enableBody=!0,this.body.setSize(160,80,30,100),this.body.immovable=!0,this.inputEnabled=!0,this.input.useHandCursor=!0,this.body.onCollide=new Phaser.Signal,this.events.onInputDown.add(this.playerAttack,this),this.still()},RPG.Final_boss.prototype=Object.create(Phaser.Sprite.prototype),RPG.Final_boss.prototype.constructor=RPG.Final_boss,RPG.Final_boss.prototype.update=function(){if(this.isJumping||(shadow.x=this.x,shadow.y=this.y),this.y>Player.y?RPG.game.world.bringToTop(RPG.GameState.enemies):RPG.game.world.bringToTop(Player),RPG.game.world.bringToTop(RPG.GameState.enemyProjectiles),"hover"===this.state||"jump"===this.state)return void(this.nextMoveFired=!1);if("move"===this.state){if(this.isMoving&&this.x>=this.targetX-5&&this.x<=this.targetX+5){if(this.shootingTimer.stop(),this.isAttacking=!1,this.body.velocity.setTo(0),this.isMoving=!1,!this.nextMoveFired){var t=this;setTimeout(function(){t.isDead||t.selectNextMove()},Rnd.integer(100,500))}this.state="hover",this.nextMoveFired=!0}}else"shoot"===this.state?(this.frame=0,this.state="hover",this.engageShooting()):"strike"===this.state&&(this.nextMoveFired=!1,(this.x>=this.targetX-5&&this.x<=this.targetX+5||this.y>=this.targetY-5&&this.y<=this.targetY+5)&&(this.body.velocity.setTo(0),this.targetX=this.returnX,this.targetY=this.returnY,RPG.game.physics.arcade.distanceBetween(this,Player)<=80&&RPG.GameState.playerHit(this.data.attack,this.faceDirection(Player.world.x,Player.world.y,!0)),this.state="move",RPG.game.physics.arcade.moveToXY(this,this.returnX,this.returnY,400)))},RPG.Final_boss.prototype.still=function(){this.frame=0},RPG.Final_boss.prototype.hover=function(){this.shootingTimer.stop(),this.state="hover",this.isMoving=!1,this.animations.play("hover")},RPG.Final_boss.prototype.missile=function(){if(!this.isDead){this.invulnerable=!0,this.isAttacking=!0,this.isMoving=!1;var t=this,e=Rnd.integer(3),i=setInterval(function(){t.animations.play("missile"),t.game.sound.play("orc_attack");var s=t.missileGroup.getFirstExists(!1);if(s)s.reset(t.x-t.width/5,t.y-t.height);else{var s=RPG.game.add.sprite(t.x-t.width/5,t.y-t.height,"missile");s.anchor.set(.5),s.animations.add("explode")}var a=t.missileGroup.getFirstExists(!1);if(a)a.reset(t.x+t.width/5,t.y-t.height);else{var a=RPG.game.add.sprite(t.x+t.width/5,t.y-t.height,"missile");a.anchor.set(.5),a.animations.add("explode")}var o=(RPG.game.add.tween(s).to({y:0},100,null).start(),RPG.game.add.tween(a).to({y:0},100,null).start());o.onComplete.add(function(){t.missileFall(s),t.missileFall(a)},t),e<=0?(clearInterval(i),setTimeout(function(){t.move()},400)):e--},1e3)}},RPG.Final_boss.prototype.missileFall=function(t){var e=Rnd.integer(this.xBounds[0],this.xBounds[1]),i=Rnd.integer(this.yBounds[0],this.yBounds[1]);t.x=e,t.scale.set(1,-1);var s=RPG.game.add.sprite(e,i,"shadow");s.anchor.setTo(.5),s.scale.setTo(.25),s.alpha=0;var a=RPG.game.add.tween(s).to({alpha:1},1e3,null).start();a.onComplete.add(function(){a=RPG.game.add.tween(t).to({x:e,y:i},400,null).start(),a.onComplete.add(function(){s.destroy(),RPG.game.sound.play("missile_explode");var e=t.animations.play("explode",16,!1);if(RPG.game.physics.arcade.distanceBetween(t,Player)<=80&&RPG.GameState.playerHit(2,this.faceDirection(Player.world.x,Player.world.y,!0)),Rnd.bit(.2)){var i=new RPG.Item(RPG.GameState,t.x,t.y,"hearts");RPG.GameState.droppedItems.add(i)}e.onComplete.add(function(){t.kill()},this)},this)},this)},RPG.Final_boss.prototype.selectNextMove=function(){var t=this.moveChance[Rnd.integer(20)];return this.states[t]()},RPG.Final_boss.prototype.move=function(){if(!this.isDead){this.invulnerable=!0,this.state="move",this.isMoving=!0,this.animations.play("hover"),this.targetX=Math.floor(Rnd(this.xBounds[0],this.xBounds[1]));var t=this.x>this.targetX?-1:1;this.body.velocity.x=200*t}},RPG.Final_boss.prototype.recharge=function(){if(!this.isDead){this.shootingTimer.stop(),this.state="hover",this.invulnerable=!1,this.powerDown.play();var t=this.animations.play("fall");t.onComplete.add(function(){this.animations.play("recharge");var e=this;this.rechargeAudio.play(),setTimeout(function(){e.isDead||(e.invulnerable=!0,e.rechargeAudio.stop(),e.powerDown.play(),t=e.animations.play("getUp"),t.onComplete.add(function(){e.isDead||e.move()},this))},Rnd.integer(1500,2400))},this)}},RPG.Final_boss.prototype.strike=function(){this.isDead||(this.returnX=this.x,this.targetX=Player.x,this.targetY=Player.y,this.state="strike",this.game.sound.play("explosion"),this.frame=0,RPG.game.physics.arcade.moveToXY(this,this.targetX,this.targetY,400))},RPG.Final_boss.prototype.sweep=function(){if(!this.isDead){this.state="move",this.animations.play("hover");var e=t.add.tween(this).to({x:this.xBounds[0],y:this.startPos[1]},800,null).start();e.onComplete.add(function(){var t=this;setTimeout(function(){t.targetX=t.xBounds[1],t.targetY=t.y,t.state="move",t.isMoving=!0,t.shootRate=.6,t.shootType=0,t.shootInteger=0,t.shootMax=8,t.isAttacking=!0,t.isMoving=!0,t.animations.play("attack"),RPG.game.physics.arcade.moveToXY(t,t.targetX,t.targetY,200),t.shootingTimer.start(),t.scheduleShooting()},600)},this)}},RPG.Final_boss.prototype.engageShooting=function(){this.isDead||(this.invulnerable=!0,this.isAttacking=!0,this.isMoving=!1,this.animations.play("attack"),this.shootType=Rnd.integer(4),3===this.shootType?(this.shootRate=.2,this.shootMax=16):(this.shootRate=.05,this.shootMax=24),this.shootInteger=0,this.x<=700?this.shootDirection=1:this.x>=1e3?this.shootDirection=-1:this.shootDirection=Rnd.sign(),this.shootingTimer.start(),this.scheduleShooting())},RPG.Final_boss.prototype.scheduleShooting=function(){this.createEnemyProjectile("bullet"),this.shootingTimer.add(Phaser.Timer.SECOND*this.shootRate,this.scheduleShooting,this)},RPG.Final_boss.prototype.scheduleMissile=function(){},RPG.Final_boss.prototype.createEnemyProjectile=function(t){var e=RPG.GameState.enemyProjectiles.getFirstExists(!1);if(e)e.reset(this.x-(this.width/2-26),this.y-this.height/2);else{var e=new RPG.Projectile(RPG.GameState,this.x-(this.width/2-26),this.y-this.height/2,t);RPG.GameState.enemyProjectiles.add(e)}var i=RPG.GameState.enemyProjectiles.getFirstExists(!1);if(i)i.reset(this.x+(this.width/2-16),this.y-this.height/2);else{var i=new RPG.Projectile(RPG.GameState,this.x+(this.width/2-16),this.y-this.height/2,t);RPG.GameState.enemyProjectiles.add(i)}switch(e.origin=this,i.origin=this,this.shootType){case 0:RPG.game.physics.arcade.moveToXY(e,e.x,1600,e.data.speed+100),RPG.game.physics.arcade.moveToXY(i,i.x,1600,i.data.speed+100);break;case 1:RPG.game.physics.arcade.moveToXY(e,e.x+this.shootDirection*(480-30*this.shootInteger),1600,e.data.speed+200),RPG.game.physics.arcade.moveToXY(i,i.x+this.shootDirection*(480-30*this.shootInteger),1600,i.data.speed+200);break;case 2:RPG.game.physics.arcade.moveToXY(e,e.x-(480-30*this.shootInteger),1600,e.data.speed+200),RPG.game.physics.arcade.moveToXY(i,i.x+(480-30*this.shootInteger),1600,i.data.speed+200);break;case 3:RPG.game.physics.arcade.moveToXY(e,e.x+this.shootDirection*(1200-100*this.shootInteger),1600,e.data.speed+200),RPG.game.physics.arcade.moveToXY(i,i.x+this.shootDirection*(1200-100*this.shootInteger),1600,i.data.speed+200)}RPG.game.sound.play("projectile"),this.shootInteger===this.shootMax?(this.shootingTimer.stop(),this.shootInteger=0,this.move()):this.shootInteger++},RPG.Final_boss.prototype.jump=function(){if(!this.isJumping&&!this.isDead){this.invulnerable=!0,this.isJumping=!0,this.state="hover",this.jumpNums=Rnd.integer(4),this.animations.play("jump");var t=this;setTimeout(function(){t.initJump()},100)}},RPG.Final_boss.prototype.initJump=function(){var t=RPG.game.add.tween(shadow).to({alpha:0},200,null).start();RPG.game.add.tween(this).to({y:-200},160,null).start(),RPG.game.sound.play("orc_attack");var e=Player.x+Rnd.sign()+Rnd.integer(0,150),i=Player.y+Rnd.sign()+Rnd.integer(0,110),s=this;setTimeout(function(){shadow.x=e,shadow.y=i,s.x=e,t=RPG.game.add.tween(shadow).to({alpha:1},600,null).start(),t.onComplete.add(function(){t=RPG.game.add.tween(s).to({y:i},200,null).start(),t.onComplete.add(function(){if(RPG.game.physics.arcade.distanceBetween(s,Player)<=120&&RPG.GameState.playerHit(s.data.attack,s.faceDirection(Player.world.x,Player.world.y,!0)),Rnd.bit(.4)){var e=new RPG.Item(RPG.GameState,s.x,s.y,"hearts");RPG.GameState.droppedItems.add(e)}s.jumpNums--,RPG.game.sound.play("explosion"),t=RPG.GameState.add.tween(RPG.GameState.camera).to({x:RPG.GameState.camera.x+30,y:RPG.GameState.camera.y+30},100,Phaser.Easing.Bounce.InOut,!1,null,1,!0).start(),t.onComplete.add(function(){s.jumpNums<=0?(s.jumpNums=0,s.isJumping=!1,s.reset()):s.initJump()},this)},this)},this)},Rnd.integer(800,1e3))},RPG.Final_boss.prototype.shakeCamera=function(){RPG.GameState.add.tween(RPG.GameState.camera).to({x:Rnd.integer(20,80),y:Rnd.integer(20,80)},100,Phaser.Easing.Bounce.InOut,!1,null,!0)},RPG.Final_boss.prototype.reset=function(){this.state="hover",this.animations.play("hover"),shadow.alpha=1;var e=t.add.tween(this).to({x:this.startPos[0],y:this.startPos[1]},800,null).start();e.onComplete.add(function(){var t=this;setTimeout(function(){t.move()},500)},this)},RPG.Final_boss.prototype.playerAttack=function(){RPG.GameState.faceDirection(Player,this.x,this.y),Player.attackTarget=this},RPG.Final_boss.prototype.defeated=function(){RPG.continueData.fbData.final_boss?RPG.continueData.fbData.final_boss++:RPG.continueData.fbData.final_boss=1;var t=RPG.firebase.database();t=t.ref("/Data").child(RPG.continueData.fbKey),t.set(RPG.continueData.fbData),RPG.GameState.bg.events.onInputDown.removeAll(),RPG.GameState.dialogueUp=!0,this.data.dialogueIndex=1,this.state="hover",this.animations.play("hover"),RPG.GameState.music.stop(),RPG.game.add.tween(Player).to({x:RPG.game.world.centerX,y:RPG.game.world.centerY+120},800,null).start();var e=RPG.game.add.tween(this).to({x:this.startPos[0],y:this.startPos[1]},800,null).start();e.onComplete.add(function(){this.animations.play("fall");this.rechargeAudio.stop(),this.powerDown.play();var t=this;this.explosionInterval=setInterval(function(){t.explosion()},200),RPG.GameState.initDialogue(this.data,!1,!1)},this)},RPG.Final_boss.prototype.explosion=function(){var t=Rnd.integer(this.x-this.width/2,this.x+this.width/2),e=Rnd.integer(this.y-this.height/2,this.y+60),i=this.missileGroup.getFirstExists(!1);if(i)i.reset(t,e),i.frame=2;else{var i=RPG.game.add.sprite(t,e,"missile");i.anchor.setTo(.5),i.animations.add("explode",[2,3,4,5,6,7],8),i.frame=2}RPG.game.sound.play("explosion"),i.setFrame(2);var s=i.animations.play("explode");s.onComplete.add(function(){i.kill()},this)},RPG.Final_boss.prototype.faceDirection=function(t,e,i){var s=t,a=e,o=RPG.game.physics.arcade.angleToXY(this,s,a);if(this.scale.setTo(1),o>-.785&&o<.785){if(i)return"left";this.data.isShooter?this.animations.play("swingSide"):this.animations.play("walkLft")}else if(o>.785&&o<2.356){if(i)return"top";this.data.isShooter?this.animations.play("swingFwd"):this.animations.play("walkFwd")}else if(o>2.356||o<-2.356){if(i)return"right";this.data.isShooter?(this.animations.play("swingSide"),this.scale.setTo(-1,1)):this.animations.play("walkRgt")}else if(o<-.785&&o>-2.356){if(i)return"bottom";this.data.isShooter?this.animations.play("swingBwd"):this.animations.play("walkBwd")}};